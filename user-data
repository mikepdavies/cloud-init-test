#cloud-config
autoinstall:

  version: 1

  interactive-sections:
    - network

  locale: en_GB.UTF-8
  keyboard:
    layout: gb
  timezone: Europe/London

  ssh:
    allow-pw: false
    install-server: false

  packages:
    - htop
    - p7zip-full
  #  - ubuntu-desktop
  #  - unattended-upgrades
  package_update: false
  package_upgrade: false
  #package_reboot_if_required: true

  # Write script to /var/lib/cloud/scripts/per-once and then
  # this will get executed on first boot, or per-boot for every boot

  user-data:
    disable_root: false

  resize_rootfs: false

  identity:
    hostname: ubuntu-00
    password: "$6$svbEVZfFcJ/cG$aeDYWh6vvELEscDhhzdq.J8yKJgYTnI2ni9tVH3bp7LZBUZ3lvmN.wQFBsuqQ/kI5rwJr3qfSLIrToihE0Xkz/" # LetSleepingCatsLie!
    username: ubuntu # root doesn't work

  disk_setup:
    /dev/sda:
      table_type: 'mbr'
      layout:
        - 10
        - 80
        - 10
      overwrite: true
  
  fs_setup:
    - label: boot
      filesystem: 'ext4'
      device: /dev/vda
      partition: vda1
      overwrite: true
    - label: root_fs
      filesystem: 'ext4'
      device: /dev/vda
      partition: vda2
      overwrite: true
    - label: swap
      filesystem: swap
      device: /dev/vda
      partition: vda3
      overwrite: true
  
  mounts:
    - ["/dev/vda1", "/boot", "ext4", "defaults", "0", "0"]
    - ["/dev/vda2", "/", "ext4", "defaults", "0", "0"]
    - ["/dev/vda3", "none", "swap", "sw", "0", "0"]

  late-commands:
    - "cp /cdrom/root-scripts/take-user-input.service /target/lib/systemd/system/"
    - "ln -s /target/lib/systemd/system/take-user-input.service /target/etc/systemd/system/multi-user.target.wants/take-user-input.service"
    - "cp /cdrom/root-scripts/test.sh /target/root/"
    - "chmod +x /target/root/test.sh"

